<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claps Analytics Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Adobe Clean', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .header h1 {
      color: #333;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 1.1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #2c3e50;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-card .number {
      font-size: 3rem;
      font-weight: bold;
      color: #ffffff;
      margin-bottom: 10px;
    }

    .stat-card .label {
      font-size: 1rem;
      color: #ecf0f1;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .table-container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .search-box {
      padding: 12px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      width: 300px;
      transition: border-color 0.3s;
    }

    .search-box:focus {
      outline: none;
      border-color: #667eea;
    }

    .filter-buttons {
      display: flex;
      gap: 10px;
    }

    .filter-btn {
      padding: 10px 20px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s;
    }

    .filter-btn:hover, .filter-btn.active {
      background: #667eea;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f8f9fa;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e0e0e0;
      cursor: pointer;
      user-select: none;
    }

    th:hover {
      background: #e9ecef;
    }

    th .sort-indicator {
      display: inline-block;
      margin-left: 5px;
      font-size: 0.8rem;
      color: #999;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .claps-count {
      font-size: 1.5rem;
      font-weight: bold;
      color: #667eea;
    }

    .article-title {
      color: #333;
      font-weight: 600;
      font-size: 1.05rem;
    }

    .article-link {
      color: #1473E6;
      text-decoration: none;
      font-size: 0.9rem;
      word-break: break-all;
    }

    .article-link:hover {
      text-decoration: underline;
    }

    .article-date {
      color: #999;
      font-size: 0.9rem;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.2rem;
      color: #666;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .emoji {
      font-size: 1.2rem;
    }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 1.1rem;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8rem;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        width: 100%;
      }

      table {
        font-size: 0.9rem;
      }

      .claps-count {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üëè Claps Analytics Dashboard</h1>
      <p>Track engagement across all your blog articles</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="number" id="totalClaps">-</div>
        <div class="label">Total Claps</div>
      </div>
      <div class="stat-card">
        <div class="number" id="totalArticles">-</div>
        <div class="label">Total Articles</div>
      </div>
      <div class="stat-card">
        <div class="number" id="avgClaps">-</div>
        <div class="label">Avg Claps/Article</div>
      </div>
      <div class="stat-card">
        <div class="number" id="topClaps">-</div>
        <div class="label">Most Claps</div>
      </div>
    </div>

    <div class="table-container">
      <div class="controls">
        <input type="text" class="search-box" id="searchBox" placeholder="üîç Search articles...">
        <div class="filter-buttons">
          <button class="filter-btn active" data-sort="claps">Sort by Claps</button>
          <button class="filter-btn" data-sort="date">Sort by Date</button>
          <button class="filter-btn" data-sort="title">Sort by Title</button>
        </div>
      </div>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading analytics data...</p>
      </div>

      <table id="articlesTable" style="display: none;">
        <thead>
          <tr>
            <th data-sort="claps">üëè Claps <span class="sort-indicator">‚ñº</span></th>
            <th data-sort="title">Article Title</th>
            <th data-sort="path">Path</th>
            <th data-sort="date">Publication Date</th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
      </table>

      <div id="noResults" class="no-results" style="display: none;">
        No articles found matching your search.
      </div>
    </div>
  </div>

  <script>
    let articles = [];
    let currentSort = 'claps';
    let sortDirection = 'desc';

    // Fetch blog articles from query-index
    async function fetchArticles() {
      try {
        console.log('Fetching /en/query-index.json...');
        const response = await fetch('/en/query-index.json');
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          console.error('Failed to fetch articles:', response.status, response.statusText);
          return [];
        }
        
        const data = await response.json();
        console.log('Raw data:', data);
        console.log('Total entries:', data.data?.length);
        
        const articles = data.data.filter(article => {
          const hasDate = !!article['publication-date'];
          console.log(`Article "${article.title}": has publication-date = ${hasDate}`);
          return hasDate;
        });
        
        console.log(`Loaded ${articles.length} articles with publication dates`);
        return articles;
      } catch (error) {
        console.error('Error fetching articles:', error);
        return [];
      }
    }

    // Fetch clap count for a specific article
    async function fetchClaps(path) {
      try {
        const response = await fetch(`https://applause.chabouis.fr/claps?url=${path}`);
        const data = await response.json();
        return data.claps || 0;
      } catch (error) {
        console.error(`Error fetching claps for ${path}:`, error);
        return 0;
      }
    }

    // Load all data
    async function loadData() {
      console.log('Starting to load data...');
      const articlesData = await fetchArticles();
      console.log(`Fetched ${articlesData.length} articles`);
      
      if (articlesData.length === 0) {
        document.getElementById('loading').innerHTML = '<p style="color: #e74c3c;">‚ö†Ô∏è No articles found. Make sure you have blog posts with publication dates.</p>';
        return;
      }
      
      // Fetch claps for each article
      const articlesWithClaps = await Promise.all(
        articlesData.map(async (article) => {
          const path = article.path.replace('.html', '');
          const claps = await fetchClaps(path);
          console.log(`${path}: ${claps} claps`);
          return {
            title: article.title,
            path: path,
            date: article['publication-date'],
            claps: claps,
            description: article.description || ''
          };
        })
      );

      articles = articlesWithClaps;
      console.log(`Processed ${articles.length} articles with clap counts`);
      updateStats();
      renderTable();
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('articlesTable').style.display = 'table';
    }

    // Update statistics
    function updateStats() {
      const totalClaps = articles.reduce((sum, a) => sum + a.claps, 0);
      const totalArticles = articles.length;
      const avgClaps = totalArticles > 0 ? Math.round(totalClaps / totalArticles) : 0;
      const topClaps = articles.length > 0 ? Math.max(...articles.map(a => a.claps)) : 0;

      document.getElementById('totalClaps').textContent = totalClaps.toLocaleString();
      document.getElementById('totalArticles').textContent = totalArticles.toLocaleString();
      document.getElementById('avgClaps').textContent = avgClaps.toLocaleString();
      document.getElementById('topClaps').textContent = topClaps.toLocaleString();
    }

    // Sort articles
    function sortArticles(sortBy) {
      const direction = currentSort === sortBy && sortDirection === 'desc' ? 'asc' : 'desc';
      sortDirection = direction;
      currentSort = sortBy;

      articles.sort((a, b) => {
        let aVal = a[sortBy];
        let bVal = b[sortBy];

        if (sortBy === 'claps') {
          return direction === 'desc' ? bVal - aVal : aVal - bVal;
        } else if (sortBy === 'date') {
          return direction === 'desc' 
            ? new Date(bVal) - new Date(aVal)
            : new Date(aVal) - new Date(bVal);
        } else {
          return direction === 'desc'
            ? bVal.localeCompare(aVal)
            : aVal.localeCompare(bVal);
        }
      });

      renderTable();
    }

    // Render table
    function renderTable(filteredArticles = articles) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      if (filteredArticles.length === 0) {
        document.getElementById('articlesTable').style.display = 'none';
        document.getElementById('noResults').style.display = 'block';
        return;
      }

      document.getElementById('articlesTable').style.display = 'table';
      document.getElementById('noResults').style.display = 'none';

      filteredArticles.forEach(article => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><span class="claps-count">${article.claps}</span></td>
          <td><div class="article-title">${article.title}</div></td>
          <td><a href="${article.path}" target="_blank" class="article-link">${article.path}</a></td>
          <td><span class="article-date">${formatDate(article.date)}</span></td>
        `;
        tbody.appendChild(row);
      });

      // Update sort indicators
      document.querySelectorAll('th .sort-indicator').forEach(indicator => {
        indicator.textContent = '';
      });
      const activeTh = document.querySelector(`th[data-sort="${currentSort}"]`);
      if (activeTh) {
        const indicator = activeTh.querySelector('.sort-indicator');
        indicator.textContent = sortDirection === 'desc' ? '‚ñº' : '‚ñ≤';
      }
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Search functionality
    document.getElementById('searchBox').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = articles.filter(article => 
        article.title.toLowerCase().includes(searchTerm) ||
        article.path.toLowerCase().includes(searchTerm) ||
        article.description.toLowerCase().includes(searchTerm)
      );
      renderTable(filtered);
    });

    // Sort button handlers
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        sortArticles(e.target.dataset.sort);
      });
    });

    // Table header click handlers
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        sortArticles(th.dataset.sort);
      });
    });

    // Load data on page load
    loadData();
  </script>
</body>
</html>
